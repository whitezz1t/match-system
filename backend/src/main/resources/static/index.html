<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¯”èµ›å®æ—¶è®¡åˆ†ç³»ç»Ÿ</title>
  <script>
    // æ£€æŸ¥ sessionStorage é‡Œæœ‰æ²¡æœ‰æˆ‘ä»¬çš„â€œé€šè¡Œè¯â€
    const user = sessionStorage.getItem('match_user');
    if (!user) {
      // å¦‚æœæ²¡æœ‰ï¼Œç›´æ¥æŠŠäººè¸¢å›ç™»å½•é¡µ
      alert("æ‚¨å°šæœªç™»å½•ï¼Œè¯·å…ˆç™»å½•ï¼");
      window.location.href = 'login.html';
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    /* ç®€å•å†™ç‚¹æ ·å¼ï¼Œè®©ç•Œé¢å¥½çœ‹ç‚¹ */
    body { font-family: 'Arial', sans-serif; background-color: #f0f2f5; text-align: center; padding-top: 50px; }
    .card { background: white; width: 600px; margin: 0 auto; padding: 40px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h1 { color: #333; margin-bottom: 30px; }

    .scoreboard { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
    .player { width: 45%; }
    .player-name { font-size: 24px; color: #555; font-weight: bold; margin-bottom: 10px; }
    .score { font-size: 80px; color: #d9534f; font-weight: bold; line-height: 1; }
    .vs { font-size: 30px; color: #ccc; font-style: italic; }

    .controls { display: flex; justify-content: space-around; }
    .btn { padding: 15px 30px; font-size: 18px; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
    .btn-blue { background-color: #007bff; }
    .btn-blue:hover { background-color: #0056b3; }
    .btn-green { background-color: #28a745; }
    .btn-green:hover { background-color: #218838; }

    .info { margin-top: 20px; color: #888; font-size: 14px; }
    input { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
  </style>
</head>
<body>

<div class="card">
  <h1>ğŸ† æ¯”èµ›å®æ—¶è®¡åˆ†æ¿</h1>

  <div style="margin-bottom: 20px;">
    <label>å½“å‰æ¯”èµ›ID: </label>
    <input type="number" id="matchIdInput" value="1" style="width: 50px;">
    <button onclick="loadMatchInfo()" style="padding: 5px 10px;">åˆ·æ–°æ¯”èµ›ä¿¡æ¯</button>
  </div>

  <div class="scoreboard">
    <div class="player">
      <div class="player-name" id="nameA">é€‰æ‰‹A</div>
      <div class="score" id="scoreA">0</div>
    </div>
    <div class="vs">VS</div>
    <div class="player">
      <div class="player-name" id="nameB">é€‰æ‰‹B</div>
      <div class="score" id="scoreB">0</div>
    </div>
  </div>

  <div class="controls">
    <button class="btn btn-blue" onclick="addScore('A')">é€‰æ‰‹A å¾—åˆ† +1</button>
    <button class="btn btn-green" onclick="addScore('B')">é€‰æ‰‹B å¾—åˆ† +1</button>
  </div>

  <div class="info">çŠ¶æ€: <span id="status">è¿æ¥ä¸­...</span></div>
  <div id="scoreChart" style="width: 100%; height: 300px; margin-top: 30px;"></div>
</div>

<script>
  // å…¨å±€å˜é‡
  let currentMatch = null;

  // 1. åŠ è½½æ¯”èµ›åŸºæœ¬ä¿¡æ¯
  async function loadMatchInfo() {
    // 1. å…ˆçœ‹çœ‹ç½‘å€æ é‡Œæœ‰æ²¡æœ‰ ?id=xxx
    const urlParams = new URLSearchParams(window.location.search);
    const urlMatchId = urlParams.get('id');

    // å¦‚æœç½‘å€æœ‰IDï¼Œå°±ä¼˜å…ˆç”¨ç½‘å€çš„ï¼Œå¦åˆ™ç”¨è¾“å…¥æ¡†çš„
    const matchId = urlMatchId || document.getElementById('matchIdInput').value;

    // æŠŠè¾“å…¥æ¡†çš„å€¼ä¹Ÿæ›´æ–°ä¸€ä¸‹
    document.getElementById('matchIdInput').value = matchId;
    try {
      // è°ƒç”¨åç«¯æ¥å£è·å–æ‰€æœ‰æ¯”èµ›ï¼Œè¿™é‡Œç®€å•å¤„ç†ï¼Œéå†æ‰¾åˆ°å¯¹åº”ID
      // å®é™…å¼€å‘ä¸­åº”è¯¥å†™ä¸€ä¸ª getMatchById çš„æ¥å£
      const response = await fetch('/api/matches');
      const matches = await response.json();
      const match = matches.find(m => m.matchId == matchId);

      if (match) {
        currentMatch = match;
        document.getElementById('nameA').innerText = match.playerAName;
        document.getElementById('nameB').innerText = match.playerBName;
        updateScoreDisplay(match.finalScoreA, match.finalScoreB);
        document.getElementById('status').innerText = "æ¯”èµ›è¿›è¡Œä¸­ (å®æ—¶åŒæ­¥)";
      } else {
        alert("æ‰¾ä¸åˆ°IDä¸º " + matchId + " çš„æ¯”èµ›ï¼Œè¯·å…ˆåˆ›å»ºæ¯”èµ›ï¼");
      }
    } catch (e) {
      console.error(e);
      document.getElementById('status').innerText = "è¿æ¥æœåŠ¡å™¨å¤±è´¥";
    }
  }

  // 2. æ›´æ–°é¡µé¢ä¸Šçš„æ•°å­—
  function updateScoreDisplay(scoreA, scoreB) {
    document.getElementById('scoreA').innerText = scoreA;
    document.getElementById('scoreB').innerText = scoreB;
    // æ¯æ¬¡æ›´æ–°åˆ†æ•°æ—¶ï¼Œé¡ºä¾¿é‡ç»˜å›¾è¡¨
    if(currentMatch) updateChart(currentMatch.matchId);
  }

  // 3. è®°åˆ†åŠŸèƒ½ (æ ¸å¿ƒ)
  async function addScore(who) {
    if (!currentMatch) {
      alert("è¯·å…ˆåŠ è½½æ¯”èµ›ä¿¡æ¯ï¼");
      return;
    }

    const matchId = currentMatch.matchId;
    // åˆ¤æ–­æ˜¯è°èµ¢äº†ï¼Œè·å–å¯¹åº”çš„ ID
    const winnerId = (who === 'A') ? currentMatch.playerAId : currentMatch.playerBId;

    try {
      // å‘é€ POST è¯·æ±‚ç»™åç«¯
      const response = await fetch(`/api/matches/${matchId}/score?winnerId=${winnerId}`, {
        method: 'POST'
      });

      if (response.ok) {
        const updatedMatch = await response.json();
        // æ›´æ–°ç•Œé¢
        updateScoreDisplay(updatedMatch.finalScoreA, updatedMatch.finalScoreB);
        // ç®€å•åŠ¨ç”»æ•ˆæœ
        const scoreEl = document.getElementById(who === 'A' ? 'scoreA' : 'scoreB');
        scoreEl.style.transform = "scale(1.2)";
        setTimeout(() => scoreEl.style.transform = "scale(1)", 200);
      } else {
        alert("è®°åˆ†å¤±è´¥ï¼");
      }
    } catch (e) {
      console.error("ç½‘ç»œé”™è¯¯", e);
    }
  }

  // 4. è‡ªåŠ¨åˆ·æ–° (è½®è¯¢) - æ¯2ç§’å»é—®ä¸€ä¸‹åç«¯æœ€æ–°æ¯”åˆ†
  // è¿™æ ·å¦‚æœåˆ«äººåœ¨å¦ä¸€ä¸ªç½‘é¡µè®°åˆ†ï¼Œä½ è¿™é‡Œä¹Ÿèƒ½çœ‹åˆ°å˜åŒ–
  setInterval(async () => {
    const matchId = document.getElementById('matchIdInput').value;
    if(!matchId) return;

    const response = await fetch('/api/matches');
    const matches = await response.json();
    const match = matches.find(m => m.matchId == matchId);
    if (match) {
      updateScoreDisplay(match.finalScoreA, match.finalScoreB);
      updateChart(match.matchId);
    }
  }, 2000); // 2000æ¯«ç§’ = 2ç§’

  // 5. åˆå§‹åŒ–å›¾è¡¨
  let myChart = echarts.init(document.getElementById('scoreChart'));

  async function updateChart(matchId) {
    // è·å–åç«¯çš„æ‰€æœ‰å›åˆæ•°æ®
    const response = await fetch(`/api/matches/${matchId}/rounds`);
    const rounds = await response.json();

    // å‡†å¤‡å›¾è¡¨æ•°æ®
    // xè½´ï¼šå›åˆæ•° (1, 2, 3...)
    const roundsAxis = rounds.map(r => r.roundNumber);
    // yè½´æ•°æ®ï¼šé€‰æ‰‹Açš„å¾—åˆ†å˜åŒ–
    const dataA = rounds.map(r => r.scoreA);
    // yè½´æ•°æ®ï¼šé€‰æ‰‹Bçš„å¾—åˆ†å˜åŒ–
    const dataB = rounds.map(r => r.scoreB);

    // ECharts é…ç½®é¡¹
    const option = {
      title: { text: 'æ¯”èµ›å¾—åˆ†èµ°åŠ¿å›¾' },
      tooltip: { trigger: 'axis' },
      legend: { data: ['é€‰æ‰‹A', 'é€‰æ‰‹B'] },
      xAxis: { type: 'category', data: roundsAxis, name: 'å›åˆ' },
      yAxis: { type: 'value', name: 'å¾—åˆ†', minInterval: 1 },
      series: [
        { name: 'é€‰æ‰‹A', type: 'line', data: dataA, smooth: true, color: '#007bff' },
        { name: 'é€‰æ‰‹B', type: 'line', data: dataB, smooth: true, color: '#28a745' }
      ]
    };

    // ç”»å›¾ï¼
    myChart.setOption(option);
  }

  // é¡µé¢ä¸€æ‰“å¼€å°±å°è¯•åŠ è½½é»˜è®¤æ¯”èµ›
  loadMatchInfo();
</script>
</body>
</html>